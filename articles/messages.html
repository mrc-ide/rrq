<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>messages • rrq</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="messages">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rrq</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.23</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/rrq.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/fault-tolerance.html">Fault tolerance</a></li>
    <li><a class="dropdown-item" href="../articles/messages.html">messages</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/rrq/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>messages</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/rrq/blob/master/vignettes/messages.Rmd" class="external-link"><code>vignettes/messages.Rmd</code></a></small>
      <div class="d-none name"><code>messages.Rmd</code></div>
    </div>

    
    
<p>In addition to passing tasks (and results) between a controller and
workers, the controller can also send “messages” to workers. This
vignette shows what the possible messages do.</p>
<p>Generally, you will not need to read this vignette unless you are
either programming against rrq in interesting ways, or you have unusual
needs. Some of the interfaces here may be useful for debugging
(particularly directing particular workers to execute particular pieces
of code).</p>
<p>In order to do this, we’re going to need a queue and a worker:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mrc-ide.github.io/rrq">rrq</a></span><span class="op">)</span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"rrq:"</span>, <span class="fu">ids</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ids/man/random_id.html" class="external-link">random_id</a></span><span class="op">(</span>bytes <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_controller.html">rrq_controller</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_default_controller_set.html">rrq_default_controller_set</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span><span class="va">logdir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_worker_spawn.html">rrq_worker_spawn</a></span><span class="op">(</span>logdir <span class="op">=</span> <span class="va">logdir</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Spawning 1 worker with prefix 'nonspheric_siberiantiger'</span></span>
<span><span class="va">worker_id</span> <span class="op">&lt;-</span> <span class="va">w</span><span class="op">$</span><span class="va">id</span></span></code></pre></div>
<p>On startup the worker log contains:</p>
<pre class="plain"><code>[2025-05-09 15:33:11.007119] ALIVE
[2025-05-09 15:33:11.007954] ENVIR new
[2025-05-09 15:33:11.008317] QUEUE default
                                 __
                ______________ _/ /
      ______   / ___/ ___/ __ `/ /_____
     /_____/  / /  / /  / /_/ /_/_____/
 ______      /_/  /_/   \__, (_)   ______
/_____/                   /_/     /_____/
    worker:        nonspheric_siberiantiger_1
    config:        localhost
    rrq_version:   0.7.23
    platform:      x86_64-pc-linux-gnu
    running:       Ubuntu 24.04.2 LTS
    hostname:      fv-az1118-568
    username:      runner
    queue:         rrq:c29119c2:queue:default
    wd:            /home/runner/work/rrq/rrq/vignettes
    pid:           8789
    redis_host:    127.0.0.1
    redis_port:    6379
    heartbeat_key: &lt;not set&gt;
    offload_path:  &lt;not set&gt;</code></pre>
<p>Because one of the main effects of messages is to print to the worker
logfile, we’ll print this fairly often.</p>
<div class="section level2">
<h2 id="messages-and-responses">Messages and responses<a class="anchor" aria-label="anchor" href="#messages-and-responses"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>The queue sends a message for one or more workers to process. The
message has an <em>identifier</em> that is derived from the current
time. Messages are written to a first-in-first-out queue, <em>per
worker</em>, and are processed independently by workers who do not look
to see if other workers have messages or are processing them.</p></li>
<li><p>As soon as a worker has finished processing any current job it
will process the message (it must wait to finish a current job but will
not start any further jobs).</p></li>
<li><p>Once the message has been processed (see below) a response will
be written to a response list with the same identifier as the
message.</p></li>
</ol>
<p>Some messages interact with the worker timeout:</p>
<ul>
<li>
<code>PING</code>, <code>ECHO</code>, <code>EVAL</code>,
<code>INFO</code> <code>PAUSE</code>, <code>RESUME</code> and
<code>REFRESH</code> will reset the timer, as if a task had been
run</li>
<li>
<code>TIMEOUT_SET</code> explicitly interacts with the timer</li>
<li>
<code>TIMEOUT_GET</code> does not reset the timer, reporting the
remaining time</li>
<li>
<code>STOP</code> causes the worker to exit, so has no interaction
with the timer</li>
</ul>
</div>
<div class="section level2">
<h2 id="ping">
<code>PING</code><a class="anchor" aria-label="anchor" href="#ping"></a>
</h2>
<p>The <code>PING</code> message simply asks the worker to return
<code>PONG</code>. It’s useful for diagnosing communication issues
because it does so little</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">message_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_message_send.html">rrq_message_send</a></span><span class="op">(</span><span class="st">"PING"</span><span class="op">)</span></span></code></pre></div>
<p>The message id is going to be useful for getting responses:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">message_id</span></span>
<span><span class="co">#&gt; [1] "1746804791.239048"</span></span></code></pre></div>
<p>(this is derived from the current time, according to Redis which is
the central reference point of time for the whole system).</p>
<pre class="plain"><code>[2025-05-09 15:33:11.239455] MESSAGE PING
PONG
[2025-05-09 15:33:11.240036] RESPONSE PING</code></pre>
<p>The logfile prints:</p>
<ol style="list-style-type: decimal">
<li>the request for the <code>PING</code>
(<code>MESSAGE PING</code>)</li>
<li>the value <code>PONG</code> to the R message stream</li>
<li>logging a response (<code>RESPONSE PONG</code>), which means that
something is written to the response stream.</li>
</ol>
<p>We can access the same bits of information in the worker log:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_worker_log_tail.html">rrq_worker_log_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="co">#&gt;                    worker_id child       time  command message</span></span>
<span><span class="co">#&gt; 1 nonspheric_siberiantiger_1    NA 1746804791    ALIVE        </span></span>
<span><span class="co">#&gt; 2 nonspheric_siberiantiger_1    NA 1746804791    ENVIR     new</span></span>
<span><span class="co">#&gt; 3 nonspheric_siberiantiger_1    NA 1746804791    QUEUE default</span></span>
<span><span class="co">#&gt; 4 nonspheric_siberiantiger_1    NA 1746804791  MESSAGE    PING</span></span>
<span><span class="co">#&gt; 5 nonspheric_siberiantiger_1    NA 1746804791 RESPONSE    PING</span></span></code></pre></div>
<p>This includes the <code>ALIVE</code> message as the worker comes
up.</p>
<p>Inspecting the logs is fine for interactive use, but it’s going to be
more useful often to poll for a response.</p>
<p>We already know that our worker has a response, but we can ask
anyway:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_message_has_response.html">rrq_message_has_response</a></span><span class="op">(</span><span class="va">message_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; nonspheric_siberiantiger_1 </span></span>
<span><span class="co">#&gt;                       TRUE</span></span></code></pre></div>
<p>Or inversely we can as what messages a given worker has responses
for:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_message_response_ids.html">rrq_message_response_ids</a></span><span class="op">(</span><span class="va">worker_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1746804791.239048"</span></span></code></pre></div>
<p>To fetch the responses from all workers it was sent to (always
returning a named list):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_message_get_response.html">rrq_message_get_response</a></span><span class="op">(</span><span class="va">message_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; [1] "PONG"</span></span></code></pre></div>
<p>or to fetch the response from a given worker:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_message_get_response.html">rrq_message_get_response</a></span><span class="op">(</span><span class="va">message_id</span>, <span class="va">worker_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; [1] "PONG"</span></span></code></pre></div>
<p>The response can be deleted by passing <code>delete = TRUE</code> to
this method:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_message_get_response.html">rrq_message_get_response</a></span><span class="op">(</span><span class="va">message_id</span>, <span class="va">worker_id</span>, delete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; [1] "PONG"</span></span></code></pre></div>
<p>after which recalling the message will throw an error:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_message_get_response.html">rrq_message_get_response</a></span><span class="op">(</span><span class="va">message_id</span>, <span class="va">worker_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `rrq_message_get_response()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Response missing for worker: 'nonspheric_siberiantiger_1'</span></span></code></pre></div>
<p>There is also a <code>timeout</code> argument that lets you wait
until a response is ready (as in <code><a href="../reference/rrq_task_wait.html">rrq_task_wait()</a></code>).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_create_expr.html">rrq_task_create_expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "aa5abd7302610e0fcc8fcbadb0c4a94e"</span></span>
<span><span class="va">message_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_message_send.html">rrq_message_send</a></span><span class="op">(</span><span class="st">"PING"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_message_get_response.html">rrq_message_get_response</a></span><span class="op">(</span></span>
<span>  <span class="va">message_id</span>, <span class="va">worker_id</span>, delete <span class="op">=</span> <span class="cn">TRUE</span>, timeout <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; [1] "PONG"</span></span></code></pre></div>
<p>Looking at the log will show what went on here:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_worker_log_tail.html">rrq_worker_log_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;                    worker_id child       time       command</span></span>
<span><span class="co">#&gt; 1 nonspheric_siberiantiger_1    NA 1746804792    TASK_START</span></span>
<span><span class="co">#&gt; 2 nonspheric_siberiantiger_1    NA 1746804794 TASK_COMPLETE</span></span>
<span><span class="co">#&gt; 3 nonspheric_siberiantiger_1    NA 1746804794       MESSAGE</span></span>
<span><span class="co">#&gt; 4 nonspheric_siberiantiger_1    NA 1746804794      RESPONSE</span></span>
<span><span class="co">#&gt;                            message</span></span>
<span><span class="co">#&gt; 1 aa5abd7302610e0fcc8fcbadb0c4a94e</span></span>
<span><span class="co">#&gt; 2 aa5abd7302610e0fcc8fcbadb0c4a94e</span></span>
<span><span class="co">#&gt; 3                             PING</span></span>
<span><span class="co">#&gt; 4                             PING</span></span></code></pre></div>
<ol style="list-style-type: decimal">
<li>A task is received</li>
<li>2s later the task is completed</li>
<li>Then the message is received</li>
<li>Then, basically instantaneously, the message is responded to</li>
</ol>
<p>However, because the message is only processed after the task is
completed, the response takes a while to come back. Equivalently, from
the worker log:</p>
<pre class="plain"><code>[2025-05-09 15:33:12.050812] TASK_START aa5abd7302610e0fcc8fcbadb0c4a94e
[2025-05-09 15:33:14.055233] TASK_COMPLETE aa5abd7302610e0fcc8fcbadb0c4a94e
[2025-05-09 15:33:14.055767] MESSAGE PING
PONG
[2025-05-09 15:33:14.056075] RESPONSE PING</code></pre>
</div>
<div class="section level2">
<h2 id="echo">
<code>ECHO</code><a class="anchor" aria-label="anchor" href="#echo"></a>
</h2>
<p>This is basically like <code>PING</code> and not very interesting; it
prints an arbitrary string to the log. It always returns
<code>"OK"</code> as a response.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">message_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_message_send.html">rrq_message_send</a></span><span class="op">(</span><span class="st">"ECHO"</span>, <span class="st">"hello world!"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_message_get_response.html">rrq_message_get_response</a></span><span class="op">(</span><span class="va">message_id</span>, <span class="va">worker_id</span>, timeout <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; [1] "OK"</span></span></code></pre></div>
<pre class="plain"><code>[2025-05-09 15:33:14.752853] MESSAGE ECHO
hello world!
[2025-05-09 15:33:14.753465] RESPONSE ECHO</code></pre>
</div>
<div class="section level2">
<h2 id="info">
<code>INFO</code><a class="anchor" aria-label="anchor" href="#info"></a>
</h2>
<p>The <code>INFO</code> command refreshes and returns the worker
information.</p>
<p>We already have a copy of the worker info; it was created when the
worker started up:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_worker_info.html">rrq_worker_info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="va">worker_id</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt;   &lt;rrq_worker_info&gt;</span></span>
<span><span class="co">#&gt;     worker:        nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt;     config:        localhost</span></span>
<span><span class="co">#&gt;     rrq_version:   0.7.23</span></span>
<span><span class="co">#&gt;     platform:      x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt;     running:       Ubuntu 24.04.2 LTS</span></span>
<span><span class="co">#&gt;     hostname:      fv-az1118-568</span></span>
<span><span class="co">#&gt;     username:      runner</span></span>
<span><span class="co">#&gt;     queue:         rrq:c29119c2:queue:default</span></span>
<span><span class="co">#&gt;     wd:            /home/runner/work/rrq/rrq/vignettes</span></span>
<span><span class="co">#&gt;     pid:           8789</span></span>
<span><span class="co">#&gt;     redis_host:    127.0.0.1</span></span>
<span><span class="co">#&gt;     redis_port:    6379</span></span>
<span><span class="co">#&gt;     heartbeat_key: NULL</span></span>
<span><span class="co">#&gt;     offload_path:  NULL</span></span></code></pre></div>
<p>We can force the worker to refresh:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">message_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_message_send.html">rrq_message_send</a></span><span class="op">(</span><span class="st">"INFO"</span><span class="op">)</span></span></code></pre></div>
<p>Here’s the new worker information, complete with an updated
<code>envir</code> field:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_message_get_response.html">rrq_message_get_response</a></span><span class="op">(</span><span class="va">message_id</span>, <span class="va">worker_id</span>, timeout <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$worker</span></span>
<span><span class="co">#&gt; [1] "nonspheric_siberiantiger_1"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$config</span></span>
<span><span class="co">#&gt; [1] "localhost"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$rrq_version</span></span>
<span><span class="co">#&gt; [1] "0.7.23"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$platform</span></span>
<span><span class="co">#&gt; [1] "x86_64-pc-linux-gnu"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$running</span></span>
<span><span class="co">#&gt; [1] "Ubuntu 24.04.2 LTS"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$hostname</span></span>
<span><span class="co">#&gt; [1] "fv-az1118-568"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$username</span></span>
<span><span class="co">#&gt; [1] "runner"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$queue</span></span>
<span><span class="co">#&gt; [1] "rrq:c29119c2:queue:default"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$wd</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/rrq/rrq/vignettes"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$pid</span></span>
<span><span class="co">#&gt; [1] 8789</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$redis_host</span></span>
<span><span class="co">#&gt; [1] "127.0.0.1"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$redis_port</span></span>
<span><span class="co">#&gt; [1] 6379</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$heartbeat_key</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1$offload_path</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="eval">
<code>EVAL</code><a class="anchor" aria-label="anchor" href="#eval"></a>
</h2>
<p>Evaluate an arbitrary R expression, passed as a string (<em>not</em>
as any sort of unevaluated or quoted expression). This expression is
evaluated in the global environment, which is <em>not</em> the
environment in which queued code is evaluated in.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">message_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_message_send.html">rrq_message_send</a></span><span class="op">(</span><span class="st">"EVAL"</span>, <span class="st">"1 + 1"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_message_get_response.html">rrq_message_get_response</a></span><span class="op">(</span><span class="va">message_id</span>, <span class="va">worker_id</span>, timeout <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; [1] 2</span></span></code></pre></div>
<p>This could be used to evaluate code that has side effects, such as
installing packages. However, due to limitations with how R loads
packages the only way to update and reload a package is going to be to
restart the worker.</p>
</div>
<div class="section level2">
<h2 id="pause-resume">
<code>PAUSE</code> / <code>RESUME</code><a class="anchor" aria-label="anchor" href="#pause-resume"></a>
</h2>
<p>The <code>PAUSE</code> / <code>RESUME</code> messages can be used to
prevent workers from picking up new work (and then allowing them to
start again).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_worker_status.html">rrq_worker_status</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; nonspheric_siberiantiger_1 </span></span>
<span><span class="co">#&gt;                     "IDLE"</span></span>
<span><span class="va">message_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_message_send.html">rrq_message_send</a></span><span class="op">(</span><span class="st">"PAUSE"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_message_get_response.html">rrq_message_get_response</a></span><span class="op">(</span><span class="va">message_id</span>, <span class="va">worker_id</span>, timeout <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; [1] "OK"</span></span>
<span><span class="fu"><a href="../reference/rrq_worker_status.html">rrq_worker_status</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; nonspheric_siberiantiger_1 </span></span>
<span><span class="co">#&gt;                   "PAUSED"</span></span></code></pre></div>
<p>Once paused workers ignore tasks, which stay on the queue:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_task_create_expr.html">rrq_task_create_expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_task_status.html">rrq_task_status</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "PENDING"</span></span></code></pre></div>
<p>Sending a <code>RESUME</code> message unpauses the worker:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">message_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_message_send.html">rrq_message_send</a></span><span class="op">(</span><span class="st">"RESUME"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_message_get_response.html">rrq_message_get_response</a></span><span class="op">(</span><span class="va">message_id</span>, <span class="va">worker_id</span>, timeout <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; [1] "OK"</span></span>
<span><span class="fu"><a href="../reference/rrq_task_wait.html">rrq_task_wait</a></span><span class="op">(</span><span class="va">t</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="set_timeout-get_timeout">
<code>SET_TIMEOUT</code> / <code>GET_TIMEOUT</code><a class="anchor" aria-label="anchor" href="#set_timeout-get_timeout"></a>
</h2>
<p>Workers will quit after being left idle for more than a certain time;
this is their timeout. Only processing tasks counts as work (not
messages). You can query the timeout with <code>GET_TIMEOUT</code> and
set it with <code>SET_TIMEOUT</code>. For our worker above the timeout
is infinite; it will never quit:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_message_send_and_wait.html">rrq_message_send_and_wait</a></span><span class="op">(</span><span class="st">"TIMEOUT_GET"</span>, worker_ids <span class="op">=</span> <span class="va">worker_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; timeout_idle    remaining </span></span>
<span><span class="co">#&gt;          Inf          Inf</span></span></code></pre></div>
<p>We can set this to a finite value, in seconds:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_message_send_and_wait.html">rrq_message_send_and_wait</a></span><span class="op">(</span><span class="st">"TIMEOUT_SET"</span>, <span class="fl">600</span>, worker_ids <span class="op">=</span> <span class="va">worker_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; [1] "OK"</span></span></code></pre></div>
<p>Here the timeout is set to 10 minutes (600s).</p>
<p>Once set, the <code>TIMEOUT_GET</code> returns the length of time
remaining before the worker exits</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_message_send_and_wait.html">rrq_message_send_and_wait</a></span><span class="op">(</span><span class="st">"TIMEOUT_GET"</span>, worker_ids <span class="op">=</span> <span class="va">worker_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; timeout_idle    remaining </span></span>
<span><span class="co">#&gt;     600.0000     599.8851</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_message_send_and_wait.html">rrq_message_send_and_wait</a></span><span class="op">(</span><span class="st">"TIMEOUT_GET"</span>, worker_ids <span class="op">=</span> <span class="va">worker_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; timeout_idle    remaining </span></span>
<span><span class="co">#&gt;     600.0000     594.8315</span></span></code></pre></div>
<p>One useful pattern is to send work to workers, then set the timeout
to zero. This means that when work is complete they will exit (almost)
immediately:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_task_create_bulk_call.html">rrq_task_create_bulk_call</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_message_send.html">rrq_message_send</a></span><span class="op">(</span><span class="st">"TIMEOUT_SET"</span>, <span class="fl">0</span>, <span class="va">worker_id</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_task_wait.html">rrq_task_wait</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="../reference/rrq_task_results.html">rrq_task_results</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] 0.2621188</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] 0.4395982 0.4428071</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] 0.6248181 0.9971756 0.9929622</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; [1] 0.4135190 0.3477054 0.4453713 0.6302362</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[5]]</span></span>
<span><span class="co">#&gt; [1] 0.07060784 0.27927816 0.54133812 0.37507236 0.34581227</span></span></code></pre></div>
<p>The worker will remain idle for 60s (by default) which is the length
of time that one poll for work lasts, then it will exit.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_worker_status.html">rrq_worker_status</a></span><span class="op">(</span><span class="va">worker_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; nonspheric_siberiantiger_1 </span></span>
<span><span class="co">#&gt;                     "IDLE"</span></span>
<span><span class="fu"><a href="../reference/rrq_message_send_and_wait.html">rrq_message_send_and_wait</a></span><span class="op">(</span><span class="st">"TIMEOUT_GET"</span>, worker_ids <span class="op">=</span> <span class="va">worker_id</span><span class="op">)</span></span>
<span><span class="co">#&gt; $nonspheric_siberiantiger_1</span></span>
<span><span class="co">#&gt; timeout_idle    remaining </span></span>
<span><span class="co">#&gt;            0            0</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="messages-that-are-supported-but-use-via-wrappers">Messages that are supported but use via wrappers:<a class="anchor" aria-label="anchor" href="#messages-that-are-supported-but-use-via-wrappers"></a>
</h2>
<p>There are other methods that are typically used via methods on the
[<code>rrq_controller</code>] object.</p>
<ul>
<li>
<code>REFRESH</code>: requests that the worker refresh its
evaluation environment. Typically used via
<code><a href="../reference/rrq_worker_envir_set.html">rrq_worker_envir_set()</a></code>
</li>
<li>
<code>STOP</code>: sent with a informational message as an argument,
requests that the worker stop. Typically used via
<code><a href="../reference/rrq_worker_stop.html">rrq_worker_stop()</a></code>
</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Robert Ashton.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
