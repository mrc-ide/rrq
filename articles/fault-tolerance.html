<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Fault tolerance • rrq</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fault tolerance">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rrq</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.23</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/rrq.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/fault-tolerance.html">Fault tolerance</a></li>
    <li><a class="dropdown-item" href="../articles/messages.html">messages</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/rrq/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Fault tolerance</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/rrq/blob/master/vignettes/fault-tolerance.Rmd" class="external-link"><code>vignettes/fault-tolerance.Rmd</code></a></small>
      <div class="d-none name"><code>fault-tolerance.Rmd</code></div>
    </div>

    
    
<p>In a perfect world, nothing would fail, and this vignette would not
be needed. But here we are.</p>
<p>When you run tasks within a single process and things go wrong, you
know immediately you see it happen. With a queuing system like rrq it’s
less obvious when something bad has happened because the task is running
on another process, possibly on a different machine!</p>
<ul>
<li>Plain errors are the simplest sort of fault to recover from. Your
task throws an error, <code>rrq</code> picks this up and marks the task
as errored, and moves on to the next thing. You can then see that this
error has happened as its status.</li>
<li>If your task crashes the process it can take out the worker
(depending on how you have configured rrq; see below). In this case
nothing updates the task status, and your task appears to stay running
forever. This situation also arises if your process is killed by the
operating system (e.g., out of memory) or via some other condition
(e.g., an administrator terminating the process).</li>
<li>If your task is running on another machine and that machine becomes
unreachable (switched off, disconnects from the network, etc) your task
will never appear to finish.</li>
</ul>
<p>This vignette discusses how you can mitigate against and recover from
these sorts of issues. We start with the expected errors and build up to
considerations for creating a fault tolerant queue.</p>
<div class="section level2">
<h2 id="error-handling">Error handling<a class="anchor" aria-label="anchor" href="#error-handling"></a>
</h2>
<p>We start with the simplest sort of fault, and can just as easily
happen locally as remotely with <code>rrq</code>. In this case the
handling is fairly well defined and there’s not much you need to do.
This section is not really “fault tolerance” at all, but simply how rrq
handles errors and what you can do about it.</p>
<p>Consider this simple function which would fit a linear model between
two variables:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mrc-ide.github.io/rrq">rrq</a></span><span class="op">)</span></span>
<span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_controller.html">rrq_controller</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"rrq:"</span>, <span class="fu">ids</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ids/man/random_id.html" class="external-link">random_id</a></span><span class="op">(</span>bytes <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_default_controller_set.html">rrq_default_controller_set</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_worker_envir_set.html">rrq_worker_envir_set</a></span><span class="op">(</span><span class="fu"><a href="../reference/rrq_envir.html">rrq_envir</a></span><span class="op">(</span>sources <span class="op">=</span> <span class="st">"fault.R"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_worker_spawn.html">rrq_worker_spawn</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Spawning 1 worker with prefix 'nonspheric_siberiantiger'</span></span></code></pre></div>
<p>In the happy case, everything works as expected:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_task_create_expr.html">rrq_task_create_expr</a></span><span class="op">(</span><span class="fu">fit_model</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_task_wait.html">rrq_task_wait</a></span><span class="op">(</span><span class="va">t</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="../reference/rrq_task_status.html">rrq_task_status</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "COMPLETE"</span></span>
<span><span class="fu"><a href="../reference/rrq_task_result.html">rrq_task_result</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ x)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt; (Intercept)            x  </span></span>
<span><span class="co">#&gt;    -0.04097      1.87959</span></span></code></pre></div>
<p>But if we provide invalid input, the task will error:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_task_create_expr.html">rrq_task_create_expr</a></span><span class="op">(</span><span class="fu">fit_model</span><span class="op">(</span><span class="va">x</span>, <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_task_wait.html">rrq_task_wait</a></span><span class="op">(</span><span class="va">t</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="fu"><a href="../reference/rrq_task_result.html">rrq_task_result</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;rrq_task_error&gt;</span></span>
<span><span class="co">#&gt;   from:   model.frame.default(formula = y ~ x, drop.unused.levels = TRUE)</span></span>
<span><span class="co">#&gt;   error:  invalid type (NULL) for variable 'y'</span></span>
<span><span class="co">#&gt;   queue:  rrq:ec94d401</span></span>
<span><span class="co">#&gt;   task:   61cf8d81b04c799fa15541333a4748ca</span></span>
<span><span class="co">#&gt;   status: ERROR</span></span>
<span><span class="co">#&gt;   * To throw this error, use stop() with it</span></span>
<span><span class="co">#&gt;   * This error has a stack trace, use '$trace' to see it</span></span></code></pre></div>
<p>The first thing to note here is that the task does not throw an error
when you fetch the result, either via <code>task_wait</code> as above,
or via <code>task_result</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_task_result.html">rrq_task_result</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="va">r</span></span>
<span><span class="co">#&gt; &lt;rrq_task_error&gt;</span></span>
<span><span class="co">#&gt;   from:   model.frame.default(formula = y ~ x, drop.unused.levels = TRUE)</span></span>
<span><span class="co">#&gt;   error:  invalid type (NULL) for variable 'y'</span></span>
<span><span class="co">#&gt;   queue:  rrq:ec94d401</span></span>
<span><span class="co">#&gt;   task:   61cf8d81b04c799fa15541333a4748ca</span></span>
<span><span class="co">#&gt;   status: ERROR</span></span>
<span><span class="co">#&gt;   * To throw this error, use stop() with it</span></span>
<span><span class="co">#&gt;   * This error has a stack trace, use '$trace' to see it</span></span></code></pre></div>
<p>However, the result will be an object of <code>rrq_task_error</code>
which you can test for using <code>inherits</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">r</span>, <span class="st">"rrq_task_error"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>The default behaviour of <code>rrq</code> is not to error when
fetching a task as that would require that you use <code>tryCatch</code>
everywhere where you retrieve tasks that might have failed, and because
errors are often interesting themselves. For example,
<code>rrq_task_error</code> objects include stack traces alongside the
error:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="va">trace</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">     </span>▆</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  1. </span>├─<span style="font-weight: bold;">rlang</span>::try_fetch(...)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  2. </span>│ ├─<span style="font-weight: bold;">base</span>::tryCatch(...)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  3. </span>│ │ └─base (local) tryCatchList(expr, classes, parentenv, handlers)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  4. </span>│ │   └─base (local) tryCatchOne(expr, names, parentenv, handlers[[1L]])</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  5. </span>│ │     └─base (local) doTryCatch(return(expr), name, parentenv, handler)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  6. </span>│ └─base::withCallingHandlers(...)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  7. </span>├─base::eval(task$expr, envir)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  8. </span>│ └─base::eval(task$expr, envir)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">  9. </span>│   └─fit_model(x, NULL)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> 10. </span>│     ├─<span style="font-weight: bold;">stats</span>::lm(y ~ x)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> 11. </span>│     │ └─<span style="font-weight: bold;">base</span>::eval(mf, parent.frame())</span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> 12. </span>│     │   └─base::eval(mf, parent.frame())</span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> 13. </span>│     ├─<span style="font-weight: bold;">stats</span>::model.frame(formula = y ~ x, drop.unused.levels = TRUE)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> 14. </span>│     └─stats::model.frame.default(formula = y ~ x, drop.unused.levels = TRUE)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> 15. </span>└─<span style="font-weight: bold;">base</span>::.handleSimpleError(...)</span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> 16. </span>  └─<span style="font-weight: bold;">rlang</span> (local) h(simpleError(msg, call))</span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> 17. </span>    └─handlers[[3L]](cnd)</span></span></code></pre></div>
<p>These are <code>rlang</code> stack traces, which are somewhat richer
than those produced by <code><a href="https://rdrr.io/r/base/traceback.html" class="external-link">traceback()</a></code>, containing the same set
of stacks but arranged in a tree. See the <a href="https://rlang.r-lib.org/reference/trace_back.html" class="external-link">documentation
there</a> for details. This error object will also include any warnings
captured while the task ran.</p>
<p>Objects of class <code>rrq_task_error</code> inherit from
<code>error</code> and <code>condition</code> so, once thrown, will
behave as expected in programs using errors for flow control (e.g., with
<code>tryCatch</code>); you can throw them yourself with
<code><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in model.frame.default(formula = y ~ x, drop.unused.levels = TRUE): invalid type (NULL) for variable 'y'</span></span></code></pre></div>
<p>You can also change the default behaviour to error on failure by
passing <code>error = TRUE</code> to <code><a href="../reference/rrq_task_result.html">rrq_task_result()</a></code> or
<code>rrq_tasks_result()</code>, which will immediately rethrow the
error in your R session (your program could then stop or you could again
catch it with <code>tryCatch</code>):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_result.html">rrq_task_result</a></span><span class="op">(</span><span class="va">t</span>, error <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in model.frame.default(formula = y ~ x, drop.unused.levels = TRUE): invalid type (NULL) for variable 'y'</span></span></code></pre></div>
<p>This process is unchanged if the task is run in a separate process
(with <code>separate_process = TRUE</code> passed to
<code>enqueue</code>), with the same status and return type, and with
the trace information available after failure.</p>
</div>
<div class="section level2">
<h2 id="increasing-resilience-via-separate-processes">Increasing resilience via separate processes<a class="anchor" aria-label="anchor" href="#increasing-resilience-via-separate-processes"></a>
</h2>
<p>Running tasks in separate processes (e.g.,
<code>rrq_task_create_expr(mytask(), separate_process = TRUE)</code>) is
the simplest way of making things more resilient because this creates a
layer of isolation between the worker and the task. If your task crashes
R (e.g., a segmentation fault due to a bug in your C/C++ code) or is
killed by the operating system then the worker process survives and can
update the keys in Redis directly to advertise this fact. This is
generally much nicer than when the worker dies and the task status
cannot be updated.</p>
<p>The downside of using separate processes is that it is much slower;
compare the time taken to queue, run an retrieve a trivial task run in
the same worker process (look at the <code>elapsed</code> entry)</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/rrq_task_wait.html">rrq_task_wait</a></span><span class="op">(</span><span class="fu"><a href="../reference/rrq_task_create_expr.html">rrq_task_create_expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identity.html" class="external-link">identity</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.001   0.000   0.003</span></span></code></pre></div>
<p>with the same task run in a separate process on the worker</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/rrq_task_wait.html">rrq_task_wait</a></span><span class="op">(</span><span class="fu"><a href="../reference/rrq_task_create_expr.html">rrq_task_create_expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identity.html" class="external-link">identity</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, separate_process <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.001   0.000   0.341</span></span></code></pre></div>
<p>We expect this difference to be ~100 fold in local workers. Almost
all the cost is due to the overhead of starting and terminating a fresh
R session. If your queue uses a lot of packages there will be additional
overhead here too as these are loaded. However, this cost is fixed and
will decrease as a fraction of the total running time as the running
time of your task increases. So for long-running tasks the additional
safety of separate processes is probably worthwhile. For smaller tasks
you may want to make sure you run a heartbeat process so that you can
handle failures via that route.</p>
<p>Consider running some long running job; this one simply sleeps for an
hour</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_task_create_expr.html">rrq_task_create_expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">3600</span><span class="op">)</span>, separate_process <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>To simulate the process crashing, we’ve killed it. Because we have
queued this on a separate process we can use
<code><a href="../reference/rrq_task_info.html">rrq_task_info()</a></code> to fetch the process id (PID) of the
process that the task is running in (this is different to that of the
worker).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_task_info.html">rrq_task_info</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/pskill.html" class="external-link">pskill</a></span><span class="op">(</span><span class="va">info</span><span class="op">$</span><span class="va">pid</span><span class="op">)</span></span></code></pre></div>
<p>Because the task was run in a separate process, our worker could
detect that the task has died unexpectedly:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_status.html">rrq_task_status</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "DIED"</span></span></code></pre></div>
<p>This is different to the error status in the previous section (that
was ERROR). Note that if we had not run the task in a separate process
the task status would be unchanged as RUNNING) because nothing could
ever update the task status!</p>
<p>Retrieving the result has similar behaviour to the error case; we
don’t throw but instead return an object of class
<code>rrq_task_error</code> (which also inherits from <code>error</code>
and <code>condition</code>). However, this time there’s really not much
extra information in the error:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_task_result.html">rrq_task_result</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="va">r</span></span>
<span><span class="co">#&gt; &lt;rrq_task_error&gt;</span></span>
<span><span class="co">#&gt;   error:  Task not successful: DIED</span></span>
<span><span class="co">#&gt;   queue:  rrq:ec94d401</span></span>
<span><span class="co">#&gt;   task:   7a0c917d05f185dcc3884a149ea88f1d</span></span>
<span><span class="co">#&gt;   status: DIED</span></span>
<span><span class="co">#&gt;   * To throw this error, use stop() with it</span></span></code></pre></div>
<p>There’s also no trace available</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="va">trace</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="loss-of-workers">Loss of workers<a class="anchor" aria-label="anchor" href="#loss-of-workers"></a>
</h2>
<p>In this section we outline what you can do about unexplained and
unreported failures in your task, or loss of workers. This will
typically be that your worker has crashed (due to your task crashing it
perhaps), killed (e.g., by the operating system or an administrator) or
the loss of the machine that it is working on.</p>
<p>In order to enable fault tolerance for this sort of issue, you first
need to enable a “heartbeat” on the worker processes. This is a second
process on each worker that periodically writes to the Redis database on
a key that will expire in a time slightly longer than that period, in
effect making a <a href="https://en.wikipedia.org/wiki/Dead_man%27s_switch" class="external-link">dead man’s
switch</a> - see <code><a href="../reference/heartbeat.html">rrq::rrq_heartbeat</a></code> for details. So if the
worker process dies for any reason, then after a while we’ll detect that
as its key has expired. We can then take some action.</p>
<p>To enable the heartbeat, save a worker configuration before starting
a worker:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_worker_config_save.html">rrq_worker_config_save</a></span><span class="op">(</span></span>
<span>  <span class="st">"localhost"</span>,</span>
<span>  <span class="fu"><a href="../reference/rrq_worker_config.html">rrq_worker_config</a></span><span class="op">(</span>heartbeat_period <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>When you spawn a worker it will pick up this configuration, and we’ll
be able to detect if it has died.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_worker_spawn.html">rrq_worker_spawn</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Spawning 1 worker with prefix 'indistinct_indianspinyloach'</span></span></code></pre></div>
<p>In order to simulate the loss of the worker, we will kill it after
starting a long-running task:</p>
<p>Now, we can queue some long running process, which this worker will
start:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_task_create_expr.html">rrq_task_create_expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">3600</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The worker will pick the task up fairly quickly, and the status will
change to <code>RUNNING</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_status.html">rrq_task_status</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "RUNNING"</span></span>
<span><span class="fu"><a href="../reference/rrq_worker_status.html">rrq_worker_status</a></span><span class="op">(</span><span class="va">w</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; indistinct_indianspinyloach_1 </span></span>
<span><span class="co">#&gt;                        "BUSY"</span></span></code></pre></div>
<p>We kill the worker (simulating the job crashing, or the machine
turning off, etc):</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w</span><span class="op">$</span><span class="fu">kill</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Because the worker has been killed, it can’t write to redis to tell
us that the task can’t be completed, so this status will never
change:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_status.html">rrq_task_status</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "RUNNING"</span></span>
<span><span class="fu"><a href="../reference/rrq_worker_status.html">rrq_worker_status</a></span><span class="op">(</span><span class="va">w</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; indistinct_indianspinyloach_1 </span></span>
<span><span class="co">#&gt;                        "BUSY"</span></span></code></pre></div>
<p>The heartbeat will persist for 3 times the period given above (this
multiplier is not configurable and while any number greater than 1
should be OK, we picked this as it allows for occasional network
connectivity issues or slowness on the node - we may reduce it in a
future version). This means that after 9s (3 * 3s) the key will have
expired:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>We can then use the <code>worker_detect_exited()</code> method to
clean up</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_worker_detect_exited.html">rrq_worker_detect_exited</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Lost 1 worker:</span></span>
<span><span class="co">#&gt;   - indistinct_indianspinyloach_1</span></span>
<span><span class="co">#&gt; Orphaning 1 task:</span></span>
<span><span class="co">#&gt;   - a7187e6afa751d68b44b3d2f34265fbb</span></span></code></pre></div>
<p>At this point, the statuses of our task and worker are correct:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_status.html">rrq_task_status</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "DIED"</span></span>
<span><span class="fu"><a href="../reference/rrq_worker_status.html">rrq_worker_status</a></span><span class="op">(</span><span class="va">w</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; indistinct_indianspinyloach_1 </span></span>
<span><span class="co">#&gt;                        "LOST"</span></span></code></pre></div>
<p>Fetching the task result provides the same DIED error as above:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_result.html">rrq_task_result</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;rrq_task_error&gt;</span></span>
<span><span class="co">#&gt;   error:  Task not successful: DIED</span></span>
<span><span class="co">#&gt;   queue:  rrq:ec94d401</span></span>
<span><span class="co">#&gt;   task:   a7187e6afa751d68b44b3d2f34265fbb</span></span>
<span><span class="co">#&gt;   status: DIED</span></span>
<span><span class="co">#&gt;   * To throw this error, use stop() with it</span></span></code></pre></div>
<p>This is still not terribly useful, as we have not provided any
mechanism to automatically requeue a lost task or restart a dead worker,
which we cover in the next section.</p>
</div>
<div class="section level2">
<h2 id="retrying-tasks">Retrying tasks<a class="anchor" aria-label="anchor" href="#retrying-tasks"></a>
</h2>
<p>Regardless of how your tasks got to be in a broken situation, the
mechanism for getting them out of this situation remains the same; you
want to retry the task:</p>
<ul>
<li>Your task might have errored because of some resource being
unavailable or full and now it is back on line</li>
<li>The worker might have died because someone turned off the
machine</li>
<li>Your memory errors only happen sometimes and you feel lucky (in this
case you should also fix your program!)</li>
</ul>
<p>Alternatively, perhaps your task ran to successful completion but you
simply want to rerun it (e.g., some stochastic algorithm that is
displaying a non-fatal pathology).</p>
<p>You can use <code>rrq_task_retry</code> to retry any number of tasks
that have <em>completed</em> (in one of the terminal states - including
<code>COMPLETE</code> but also <code>ERROR</code>,
<code>CANCELLED</code> <code>DIED</code> or <code>TIMEOUT</code>). This
is nondestructive to any of the task data, in particular its result, so
you will still have access to the failed run and its stack trace (but
see below).</p>
<div class="section level3">
<h3 id="an-example-where-retrying-fixes-an-error">An example where retrying fixes an error<a class="anchor" aria-label="anchor" href="#an-example-where-retrying-fixes-an-error"></a>
</h3>
<p>In this example, we’ll run some “model” that may or may not converge,
and we want to retry until it does. This represents some badly behaved
task with a stochastic component that will eventually work if tried
enough times:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stochastic_failure</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">x</span> <span class="op">&lt;</span> <span class="va">p</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Convergence failure - x is only %0.2f"</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">x</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can create a new environment for our worker, to pick up this
function:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_worker_envir_set.html">rrq_worker_envir_set</a></span><span class="op">(</span><span class="fu"><a href="../reference/rrq_envir.html">rrq_envir</a></span><span class="op">(</span>sources <span class="op">=</span> <span class="st">"fault2.R"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu">rrq</span><span class="fu">::</span><span class="fu"><a href="../reference/rrq_worker_spawn.html">rrq_worker_spawn</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Spawning 1 worker with prefix 'ecological_snake'</span></span></code></pre></div>
<p>Now, we enqueue a task as usual, then wait on it</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_task_create_expr.html">rrq_task_create_expr</a></span><span class="op">(</span><span class="fu">stochastic_failure</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_task_wait.html">rrq_task_wait</a></span><span class="op">(</span><span class="va">t1</span>, timeout <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="fu"><a href="../reference/rrq_task_result.html">rrq_task_result</a></span><span class="op">(</span><span class="va">t1</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;rrq_task_error&gt;</span></span>
<span><span class="co">#&gt;   from:   stochastic_failure(0.5)</span></span>
<span><span class="co">#&gt;   error:  Convergence failure - x is only 0.27</span></span>
<span><span class="co">#&gt;   queue:  rrq:ec94d401</span></span>
<span><span class="co">#&gt;   task:   c4ab320544709b0842cbfde192a5d827</span></span>
<span><span class="co">#&gt;   status: ERROR</span></span>
<span><span class="co">#&gt;   * To throw this error, use stop() with it</span></span>
<span><span class="co">#&gt;   * This error has a stack trace, use '$trace' to see it</span></span></code></pre></div>
<p>Oh no, this task has failed!</p>
<p>We can use the <code>task_retry</code> method to requeue this job,
meaning that it will run exactly as before. However, the random number
stream has moved on and this task will return a different answer -
perhaps it will work this time?</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_task_retry.html">rrq_task_retry</a></span><span class="op">(</span><span class="va">t1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_task_wait.html">rrq_task_wait</a></span><span class="op">(</span><span class="va">t2</span>, timeout <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="fu"><a href="../reference/rrq_task_result.html">rrq_task_result</a></span><span class="op">(</span><span class="va">t2</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;rrq_task_error&gt;</span></span>
<span><span class="co">#&gt;   from:   stochastic_failure(0.5)</span></span>
<span><span class="co">#&gt;   error:  Convergence failure - x is only 0.37</span></span>
<span><span class="co">#&gt;   queue:  rrq:ec94d401</span></span>
<span><span class="co">#&gt;   task:   838eb0c3fff61b9bc61332b3194fa79c</span></span>
<span><span class="co">#&gt;   status: ERROR</span></span>
<span><span class="co">#&gt;   * To throw this error, use stop() with it</span></span>
<span><span class="co">#&gt;   * This error has a stack trace, use '$trace' to see it</span></span></code></pre></div>
<p>The task has failed again. Note here that <code>task_retry</code> has
taken a task id and returned a new task id, which we have waited on.
However, we could also have used the original id (more on this
below).</p>
<p>Let’s give it one more go:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_task_retry.html">rrq_task_retry</a></span><span class="op">(</span><span class="va">t2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_task_wait.html">rrq_task_wait</a></span><span class="op">(</span><span class="va">t3</span>, timeout <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="../reference/rrq_task_result.html">rrq_task_result</a></span><span class="op">(</span><span class="va">t3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.5728534</span></span></code></pre></div>
<p>Success! The task has run to completion and we no longer have an
error.</p>
<p>When you retry a task, rrq sets up redirects that point from the old
task id to the new one, and in most cases you can use whichever you find
more convenient. For example, we can now read the successful task result
from any of the task ids:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_results.html">rrq_task_results</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">t1</span>, <span class="va">t2</span>, <span class="va">t3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] 0.5728534</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] 0.5728534</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] 0.5728534</span></span></code></pre></div>
<p>To prevent this, pass <code>follow = FALSE</code> to return the
original result</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_results.html">rrq_task_results</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">t1</span>, <span class="va">t2</span>, <span class="va">t3</span><span class="op">)</span>, follow <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; &lt;rrq_task_error&gt;</span></span>
<span><span class="co">#&gt;   from:   stochastic_failure(0.5)</span></span>
<span><span class="co">#&gt;   error:  Convergence failure - x is only 0.27</span></span>
<span><span class="co">#&gt;   queue:  rrq:ec94d401</span></span>
<span><span class="co">#&gt;   task:   c4ab320544709b0842cbfde192a5d827</span></span>
<span><span class="co">#&gt;   status: ERROR</span></span>
<span><span class="co">#&gt;   * To throw this error, use stop() with it</span></span>
<span><span class="co">#&gt;   * This error has a stack trace, use '$trace' to see it</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; &lt;rrq_task_error&gt;</span></span>
<span><span class="co">#&gt;   from:   stochastic_failure(0.5)</span></span>
<span><span class="co">#&gt;   error:  Convergence failure - x is only 0.37</span></span>
<span><span class="co">#&gt;   queue:  rrq:ec94d401</span></span>
<span><span class="co">#&gt;   task:   838eb0c3fff61b9bc61332b3194fa79c</span></span>
<span><span class="co">#&gt;   status: ERROR</span></span>
<span><span class="co">#&gt;   * To throw this error, use stop() with it</span></span>
<span><span class="co">#&gt;   * This error has a stack trace, use '$trace' to see it</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] 0.5728534</span></span></code></pre></div>
<p>Here, we can see that the first two times we ran the task they
failed, along with the error and any backtraces. The same logic applies
to other functions, such as <code><a href="../reference/rrq_task_status.html">rrq_task_status()</a></code></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_status.html">rrq_task_status</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">t1</span>, <span class="va">t2</span>, <span class="va">t3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "COMPLETE" "COMPLETE" "COMPLETE"</span></span>
<span><span class="fu"><a href="../reference/rrq_task_status.html">rrq_task_status</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">t1</span>, <span class="va">t2</span>, <span class="va">t3</span><span class="op">)</span>, follow <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "MOVED"    "MOVED"    "COMPLETE"</span></span></code></pre></div>
<p>Note that the task status above has overwritten the original status
(previously it was ERROR, but now it is MOVED). However, you can always
read the original status in the error object’s status field, should you
need it.</p>
<p>You can also extract times that events happened with
<code><a href="../reference/rrq_task_times.html">rrq_task_times()</a></code></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_times.html">rrq_task_times</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">t1</span>, <span class="va">t2</span>, <span class="va">t3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                      submit      start   complete moved</span></span>
<span><span class="co">#&gt; c4ab320544709b0842cbfde192a5d827 1746804788 1746804788 1746804788    NA</span></span>
<span><span class="co">#&gt; 838eb0c3fff61b9bc61332b3194fa79c 1746804788 1746804788 1746804788    NA</span></span>
<span><span class="co">#&gt; 28c4f021a8be85ee2984eaea85fd936d 1746804788 1746804788 1746804788    NA</span></span>
<span><span class="fu"><a href="../reference/rrq_task_times.html">rrq_task_times</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">t1</span>, <span class="va">t2</span>, <span class="va">t3</span><span class="op">)</span>, follow <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                      submit      start   complete      moved</span></span>
<span><span class="co">#&gt; c4ab320544709b0842cbfde192a5d827 1746804788 1746804788 1746804788 1746804788</span></span>
<span><span class="co">#&gt; 838eb0c3fff61b9bc61332b3194fa79c 1746804788 1746804788 1746804788 1746804788</span></span>
<span><span class="co">#&gt; 28c4f021a8be85ee2984eaea85fd936d 1746804788 1746804788 1746804788         NA</span></span></code></pre></div>
<p>This means that most of the time you can ignore that a task has been
retried and work with whatever task id you have handy.</p>
<p>You can inspect the chain of tasks by looking at the return values
<code><a href="../reference/rrq_task_info.html">rrq_task_info()</a></code>. In the above example we have a chain of
three tasks
<code>r backquote(paste0(substr(c(t1, t2, t3), 1, 6), "...", collapse = " -&gt; "))</code>,
which we can discover this way:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_info.html">rrq_task_info</a></span><span class="op">(</span><span class="va">t1</span><span class="op">)</span></span>
<span><span class="co">#&gt; $id</span></span>
<span><span class="co">#&gt; [1] "c4ab320544709b0842cbfde192a5d827"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $status</span></span>
<span><span class="co">#&gt; [1] "MOVED"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $queue</span></span>
<span><span class="co">#&gt; [1] "default"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $separate_process</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $timeout</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $worker</span></span>
<span><span class="co">#&gt; [1] "ecological_snake_1"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $pid</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $depends</span></span>
<span><span class="co">#&gt; $depends$up</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $depends$down</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $moved</span></span>
<span><span class="co">#&gt; $moved$up</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $moved$down</span></span>
<span><span class="co">#&gt; [1] "838eb0c3fff61b9bc61332b3194fa79c" "28c4f021a8be85ee2984eaea85fd936d"</span></span></code></pre></div>
<p>Here, the <code>moved</code> field shows the tasks that are upstream
(<code>up</code>) and downstream (<code>down</code>) of this task. For
tasks that have never been retried both elements are <code>NULL</code>.
The elements are always ordered from oldest to newest, and chains of
tasks are always linear (i.e., there is no forking).</p>
<p>For the middle task in the chain, both <code>up</code> and
<code>down</code> point at different tasks:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_info.html">rrq_task_info</a></span><span class="op">(</span><span class="va">t2</span><span class="op">)</span><span class="op">$</span><span class="va">moved</span></span>
<span><span class="co">#&gt; $up</span></span>
<span><span class="co">#&gt; [1] "c4ab320544709b0842cbfde192a5d827"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $down</span></span>
<span><span class="co">#&gt; [1] "28c4f021a8be85ee2984eaea85fd936d"</span></span></code></pre></div>
<p>and for the leaf task:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_info.html">rrq_task_info</a></span><span class="op">(</span><span class="va">t3</span><span class="op">)</span><span class="op">$</span><span class="va">moved</span></span>
<span><span class="co">#&gt; $up</span></span>
<span><span class="co">#&gt; [1] "c4ab320544709b0842cbfde192a5d827" "838eb0c3fff61b9bc61332b3194fa79c"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $down</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="performance-considerations">Performance considerations<a class="anchor" aria-label="anchor" href="#performance-considerations"></a>
</h3>
<p>It is possible to change the default behaviour of <code>follow</code>
to not follow through a task chain. Doing this might be slightly more
efficient in cases where you are interested in running large numbers of
small tasks and do not want to retry failed tasks. This is because
almost every request that involves a task id will have to check to see
if it has been moved.</p>
<p>To change this behaviour, pass the <code>follow</code> argument to
the queue constructor, for example:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj_nofollow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrq_controller.html">rrq_controller</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">queue_id</span>, follow <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rrq_task_result.html">rrq_task_result</a></span><span class="op">(</span><span class="va">t1</span>, controller <span class="op">=</span> <span class="va">obj_nofollow</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;rrq_task_error&gt;</span></span>
<span><span class="co">#&gt;   from:   stochastic_failure(0.5)</span></span>
<span><span class="co">#&gt;   error:  Convergence failure - x is only 0.27</span></span>
<span><span class="co">#&gt;   queue:  rrq:ec94d401</span></span>
<span><span class="co">#&gt;   task:   c4ab320544709b0842cbfde192a5d827</span></span>
<span><span class="co">#&gt;   status: ERROR</span></span>
<span><span class="co">#&gt;   * To throw this error, use stop() with it</span></span>
<span><span class="co">#&gt;   * This error has a stack trace, use '$trace' to see it</span></span></code></pre></div>
<p>Here, we would create a queue controller object with the default
follow behaviour set to <code>FALSE</code> and so accessing a task
result of a moved task would not search down through any potential
retries unless <code>follow = TRUE</code> was explicitly passed.</p>
</div>
<div class="section level3">
<h3 id="deleting-tasks-that-have-been-retried">Deleting tasks that have been retried<a class="anchor" aria-label="anchor" href="#deleting-tasks-that-have-been-retried"></a>
</h3>
<p>Deletion will operate on all tasks in a chain. So if you delete a
task that has been retried then it deletes everything upstream (up to
the original task) and downstream (down to the last time that the task
was retried). This is because otherwise it is too easy to end up with
inconsistent state. So if we run</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_delete.html">rrq_task_delete</a></span><span class="op">(</span><span class="va">t1</span><span class="op">)</span></span></code></pre></div>
<p>all three tasks in the chain are deleted:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rrq_task_status.html">rrq_task_status</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">t1</span>, <span class="va">t2</span>, <span class="va">t3</span><span class="op">)</span>, follow <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "MISSING" "MISSING" "MISSING"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="going-further">Going further<a class="anchor" aria-label="anchor" href="#going-further"></a>
</h3>
<p>Currently this system does not allow you to do a few things that
would be useful</p>
<ul>
<li>You can’t change queue when you retry a task (for configurations
with multiple queues)</li>
<li>You can’t automatically retry a task on failure (e.g., try this up
to 5 times before giving up entirely)</li>
<li>You can’t retry tasks that have become impossible due to failure of
a dependent task, even if that task has been retried and since
succeeded</li>
</ul>
<p>We will relax these limitations soon.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Robert Ashton.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
